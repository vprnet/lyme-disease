<!DOCTYPE html>
<meta charset="utf-8">

<style>
    svg {
        font: 10px sans-serif;
        display: inline;
        padding-right: 20px;
        padding-left: 20px;
    }

    text {
        fill: #999;
    }

    text.year {
        fill: #555;
    }

    .county {
        stroke-width: 1px;
        stroke: #aaa;
    }
</style>

<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/colorbrewer.v1.min.js"></script>
<script>

var width = 200,
    height = 400;

var projection = d3.geo.transverseMercator()
    .rotate([72.57, -44.20])
    .translate([90,160])
    .scale([8000]);

var path = d3.geo.path()
    .projection(projection);


var mapColor = colorbrewer.Blues[9];

var quantize = d3.scale.quantize()
    .domain([0, 150])
    .range(mapColor);

var years = ['1999', '2000', '2001', '2002', '2003', '2004', '2005', '2006',
    '2007', '2008', '2009', '2010', '2011', '2012', '2013'];

queue()
    .defer(d3.json, "static/data/vermont-counties.json")
    .defer(d3.csv, "static/data/lyme-vt-counties.csv")
    .await(ready);

// Load CSV
function ready(error, vt, data) {
    var vermont = topojson.feature(vt, vt.objects.counties);

    for (var j=0; j<years.length; j++) {
        var svg = d3.select("body").append("svg")
            .attr("x", 350*j)
            .attr("width", width)
            .attr("height", height);

        svg.append("path")
            .datum(vermont)
            .attr("d", path)
            .attr("x", j*400)
            .style("stroke-width", "1");

        svg.append("text")
            .attr("x", 65)
            .attr("y", 30)
            .style("font-size", "36px")
            .attr("class", "year")
            .text(years[j]);

        svg.append("text")
            .attr("x", 120)
            .attr("y", 335)
            .style("font-size", "48px")
            .text(function() {
                var total = 0;
                for (var i=0; i<data.length; i++) {
                    total += parseInt(data[i][years[j]]);
                }
                return total/2;
            });

        svg.append("text")
            .attr("x", 120)
            .attr("y", 365)
            .style("font-size", "30px")
            .text("cases");


        svg.selectAll(".subunit")
            .data(topojson.feature(vt, vt.objects.counties).features)
        .enter().append("path")
            .attr("d", path)
            .attr("class", "county")
            .style("fill", function(d) {
                for (var i=0; i<data.length; i++) {
                    if (data[i].county.toUpperCase() === d.properties.county) {
                        var cases = data[i][years[j]];
                        if (cases > 0) {
                            return quantize(cases);
                        } else {
                            return "#ccc";
                        }
                    }
                }
                return "#aaa";
            });
    }

};


</script>
